<!-- app/templates/admin/sales_report.html -->
{% extends "admin/base_admin.html" %}

{% block title %}Sales Report - Admin Dashboard{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="mt-4">ðŸ“Š Sales Report</h1>
        <div>
            <button class="btn btn-outline-primary" onclick="window.print()">
                <i class="fas fa-print"></i> Print Report
            </button>
            <button class="btn btn-success" onclick="exportToExcel()">
                <i class="fas fa-file-excel"></i> Export Excel
            </button>
        </div>
    </div>

    <!-- Report Period Selector -->
    <div class="card mb-4">
        <div class="card-header">
            <i class="fas fa-calendar me-1"></i>
            Report Period
        </div>
        <div class="card-body">
            <form method="GET" action="{{ url_for('admin.sales_report') }}" class="row g-3">
                <div class="col-md-3">
                    <label for="start_date" class="form-label">Start Date</label>
                    <input type="date" class="form-control" id="start_date" name="start_date" 
                           value="{{ start_date if start_date else '' }}">
                </div>
                <div class="col-md-3">
                    <label for="end_date" class="form-label">End Date</label>
                    <input type="date" class="form-control" id="end_date" name="end_date"
                           value="{{ end_date if end_date else '' }}">
                </div>
                <div class="col-md-3">
                    <label for="period" class="form-label">Quick Period</label>
                    <select class="form-select" id="period" name="period" onchange="this.form.submit()">
                        <option value="today" {% if period == 'today' %}selected{% endif %}>Today</option>
                        <option value="yesterday" {% if period == 'yesterday' %}selected{% endif %}>Yesterday</option>
                        <option value="week" {% if period == 'week' %}selected{% endif %}>This Week</option>
                        <option value="month" {% if period == 'month' %}selected{% endif %}>This Month</option>
                        <option value="quarter" {% if period == 'quarter' %}selected{% endif %}>This Quarter</option>
                        <option value="year" {% if period == 'year' %}selected{% endif %}>This Year</option>
                        <option value="custom" {% if period == 'custom' %}selected{% endif %}>Custom</option>
                    </select>
                </div>
                <div class="col-md-3 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-filter"></i> Generate Report
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="row">
        <div class="col-xl-3 col-md-6">
            <div class="card bg-primary text-white mb-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="small">Total Revenue</div>
                            <div class="fs-4 fw-bold">${{ "%.2f"|format(summary.total_revenue) }}</div>
                        </div>
                        <i class="fas fa-dollar-sign fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card bg-success text-white mb-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="small">Total Orders</div>
                            <div class="fs-4 fw-bold">{{ summary.total_orders }}</div>
                        </div>
                        <i class="fas fa-shopping-cart fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card bg-warning text-white mb-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="small">Average Order</div>
                            <div class="fs-4 fw-bold">${{ "%.2f"|format(summary.average_order_value) }}</div>
                        </div>
                        <i class="fas fa-chart-line fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card bg-info text-white mb-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="small">Completed Orders</div>
                            <div class="fs-4 fw-bold">{{ summary.completed_orders }}</div>
                        </div>
                        <i class="fas fa-check-circle fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Detailed Report -->
    <div class="card mb-4">
        <div class="card-header">
            <i class="fas fa-table me-1"></i>
            Sales Details
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover" id="salesTable">
                    <thead>
                        <tr>
                            <th>Order ID</th>
                            <th>Date & Time</th>
                            <th>Customer</th>
                            <th>Restaurant</th>
                            <th>Items</th>
                            <th>Subtotal</th>
                            <th>Tax</th>
                            <th>Delivery</th>
                            <th>Total</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for order in orders %}
                        <tr>
                            <td>
                                <a href="{{ url_for('admin.view_order', order_id=order.order_id) }}" 
                                   class="text-decoration-none">
                                    {{ order.order_id }}
                                </a>
                            </td>
                            <td>{{ order.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                            <td>
                                {% if order.customer %}
                                    {{ order.customer.name }}
                                {% else %}
                                    Guest
                                {% endif %}
                            </td>
                            <td>
                                {% if order.restaurant %}
                                    {{ order.restaurant.name }}
                                {% else %}
                                    N/A
                                {% endif %}
                            </td>
                            <td>{{ order.items_count if order.items_count else 'N/A' }}</td>
                            <td>${{ "%.2f"|format(order.subtotal) }}</td>
                            <td>${{ "%.2f"|format(order.tax) }}</td>
                            <td>${{ "%.2f"|format(order.delivery_fee) }}</td>
                            <td><strong>${{ "%.2f"|format(order.total_amount) }}</strong></td>
                            <td>
                                <span class="badge 
                                    {% if order.order_status == 'delivered' %}bg-success
                                    {% elif order.order_status == 'cancelled' %}bg-danger
                                    {% elif order.order_status == 'pending' %}bg-warning
                                    {% else %}bg-info{% endif %}">
                                    {{ order.order_status|title }}
                                </span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot>
                        <tr class="table-dark">
                            <td colspan="5" class="text-end"><strong>TOTALS:</strong></td>
                            <td><strong>${{ "%.2f"|format(totals.subtotal) }}</strong></td>
                            <td><strong>${{ "%.2f"|format(totals.tax) }}</strong></td>
                            <td><strong>${{ "%.2f"|format(totals.delivery) }}</strong></td>
                            <td><strong>${{ "%.2f"|format(totals.total) }}</strong></td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>

    <!-- Charts Section (Placeholder for future development) -->
    <div class="row">
        <div class="col-lg-6">
            <div class="card mb-4">
                <div class="card-header">
                    <i class="fas fa-chart-bar me-1"></i>
                    Revenue Trend (Coming Soon)
                </div>
                <div class="card-body">
                    <div class="chart-placeholder" style="height: 300px; display: flex; align-items: center; justify-content: center; background: #f8f9fa; border-radius: 4px;">
                        <div class="text-center text-muted">
                            <i class="fas fa-chart-bar fa-3x mb-3"></i>
                            <p>Revenue chart will be implemented soon</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="card mb-4">
                <div class="card-header">
                    <i class="fas fa-chart-pie me-1"></i>
                    Top Items (Coming Soon)
                </div>
                <div class="card-body">
                    <div class="chart-placeholder" style="height: 300px; display: flex; align-items: center; justify-content: center; background: #f8f9fa; border-radius: 4px;">
                        <div class="text-center text-muted">
                            <i class="fas fa-chart-pie fa-3x mb-3"></i>
                            <p>Product analysis will be implemented soon</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Summary Stats -->
    <div class="row">
        <div class="col-lg-4">
            <div class="card mb-4">
                <div class="card-header">
                    <i class="fas fa-store me-1"></i>
                    Restaurant Performance
                </div>
                <div class="card-body">
                    <ul class="list-group list-group-flush">
                        {% for restaurant in restaurant_stats %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            {{ restaurant.name }}
                            <span class="badge bg-primary rounded-pill">
                                ${{ "%.2f"|format(restaurant.revenue) }}
                            </span>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card mb-4">
                <div class="card-header">
                    <i class="fas fa-clock me-1"></i>
                    Peak Hours
                </div>
                <div class="card-body">
                    <ul class="list-group list-group-flush">
                        {% for hour in peak_hours %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            {{ hour.hour }}:00 - {{ hour.hour + 1 }}:00
                            <span class="badge bg-success rounded-pill">
                                {{ hour.order_count }} orders
                            </span>
                        </li>
                        {% else %}
                        <li class="list-group-item text-muted">No data available</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card mb-4">
                <div class="card-header">
                    <i class="fas fa-truck me-1"></i>
                    Delivery Stats
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-6 mb-3">
                            <div class="text-muted small">Delivery Orders</div>
                            <div class="h4">{{ delivery_stats.delivery_count }}</div>
                        </div>
                        <div class="col-6 mb-3">
                            <div class="text-muted small">Pickup Orders</div>
                            <div class="h4">{{ delivery_stats.pickup_count }}</div>
                        </div>
                        <div class="col-6">
                            <div class="text-muted small">Avg Delivery Time</div>
                            <div class="h4">{{ delivery_stats.avg_delivery_time }} min</div>
                        </div>
                        <div class="col-6">
                            <div class="text-muted small">On-time Rate</div>
                            <div class="h4">{{ delivery_stats.on_time_rate }}%</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript for Export -->
<script>
function exportToExcel() {
    alert('Excel export feature will be implemented soon!');
    // Future implementation:
    // window.location.href = "{{ url_for('admin.export_sales_report') }}?start_date={{ start_date }}&end_date={{ end_date }}";
}

// Set default dates if not set
document.addEventListener('DOMContentLoaded', function() {
    const startDateInput = document.getElementById('start_date');
    const endDateInput = document.getElementById('end_date');
    
    if (!startDateInput.value) {
        const today = new Date();
        const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
        startDateInput.valueAsDate = firstDay;
    }
    
    if (!endDateInput.value) {
        const today = new Date();
        endDateInput.valueAsDate = today;
    }
    
    // Handle period selector
    const periodSelect = document.getElementById('period');
    periodSelect.addEventListener('change', function() {
        if (this.value === 'custom') {
            startDateInput.disabled = false;
            endDateInput.disabled = false;
        } else {
            startDateInput.disabled = true;
            endDateInput.disabled = true;
        }
    });
    
    // Trigger change on load
    periodSelect.dispatchEvent(new Event('change'));
});
</script>

<style>
.chart-placeholder {
    border: 2px dashed #dee2e6;
}
.table th {
    background-color: #f8f9fa;
    font-weight: 600;
}
.card {
    border: none;
    box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
}
</style>
{% endblock %}
