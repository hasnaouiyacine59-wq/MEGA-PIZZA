<!-- templates/admin/manage_menu_items.html -->
{% extends "admin/base_admin.html" %}

{% block title %}Manage Menu Items - Mega Pizza Admin{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h2 text-white mb-0">Menu Items</h1>
            <p class="text-muted mb-0">Manage all menu items across restaurants</p>
        </div>
        <div>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addMenuItemModal">
                <i class="fas fa-plus-circle me-2"></i>Add Menu Item
            </button>
            <a href="{{ url_for('admin.manage_categories') }}" class="btn btn-outline-secondary ms-2">
                <i class="fas fa-tags me-2"></i>Categories
            </a>
        </div>
    </div>

    <!-- Filters -->
    <div class="card border-railway mb-4">
        <div class="card-body">
            <form id="filterForm" method="GET" action="{{ url_for('admin.manage_menu_items') }}">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label text-muted small">Restaurant</label>
                        <select class="form-select form-select-sm border-railway" name="restaurant_id">
                            <option value="">All Restaurants</option>
                            {% for restaurant in restaurants %}
                            <option value="{{ restaurant.restaurant_id }}" 
                                    {% if request.args.get('restaurant_id') == restaurant.restaurant_id|string %}selected{% endif %}>
                                {{ restaurant.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label text-muted small">Category</label>
                        <select class="form-select form-select-sm border-railway" name="category">
                            <option value="">All Categories</option>
                            {% for cat in categories %}
                            <option value="{{ cat }}" 
                                    {% if request.args.get('category') == cat %}selected{% endif %}>
                                {{ cat }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label text-muted small">Availability</label>
                        <select class="form-select form-select-sm border-railway" name="availability">
                            <option value="">All Items</option>
                            <option value="available" {% if request.args.get('availability') == 'available' %}selected{% endif %}>
                                Available
                            </option>
                            <option value="unavailable" {% if request.args.get('availability') == 'unavailable' %}selected{% endif %}>
                                Unavailable
                            </option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label text-muted small">&nbsp;</label>
                        <div>
                            <button type="submit" class="btn btn-sm btn-primary w-100 me-2">
                                <i class="fas fa-filter me-1"></i>Apply Filters
                            </button>
                            {% if request.args %}
                            <a href="{{ url_for('admin.manage_menu_items') }}" class="btn btn-sm btn-outline-secondary w-100 mt-2">
                                <i class="fas fa-times me-1"></i>Clear Filters
                            </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Active Filters (if any) -->
    {% if request.args and (request.args.get('restaurant_id') or request.args.get('category') or request.args.get('availability')) %}
    <div class="mb-3">
        <small class="text-muted me-2">Active filters:</small>
        {% if request.args.get('restaurant_id') %}
            {% set filtered_restaurant = restaurants|selectattr('restaurant_id', 'equalto', request.args.get('restaurant_id')|int)|first %}
            {% if filtered_restaurant %}
            <span class="badge bg-railway-secondary me-2 mb-1">
                Restaurant: {{ filtered_restaurant.name }}
                <a href="{{ url_for('admin.manage_menu_items', **remove_arg('restaurant_id')) }}" class="text-white ms-1">
                    <i class="fas fa-times"></i>
                </a>
            </span>
            {% endif %}
        {% endif %}
        
        {% if request.args.get('category') %}
        <span class="badge bg-railway-primary me-2 mb-1">
            Category: {{ request.args.get('category') }}
            <a href="{{ url_for('admin.manage_menu_items', **remove_arg('category')) }}" class="text-white ms-1">
                <i class="fas fa-times"></i>
            </a>
        </span>
        {% endif %}
        
        {% if request.args.get('availability') %}
        <span class="badge {% if request.args.get('availability') == 'available' %}bg-success{% else %}bg-danger{% endif %} me-2 mb-1">
            Status: {{ request.args.get('availability')|title }}
            <a href="{{ url_for('admin.manage_menu_items', **remove_arg('availability')) }}" class="text-white ms-1">
                <i class="fas fa-times"></i>
            </a>
        </span>
        {% endif %}
    </div>
    {% endif %}

    <!-- Menu Items Table -->
    <div class="card border-railway">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-dark table-hover mb-0">
                    <thead>
                        <tr>
                            <th class="ps-4">Item</th>
                            <th>Restaurant</th>
                            <th>Category</th>
                            <th>Price</th>
                            <th>Status</th>
                            <th>Created</th>
                            <th class="text-end pe-4">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in menu_items %}
                        <tr>
                            <td class="ps-4">
                                <div class="d-flex align-items-center">
                                    {% if item.image_url %}
                                    <img src="{{ item.image_url }}" alt="{{ item.name }}" 
                                         class="rounded me-3" width="40" height="40">
                                    {% else %}
                                    <div class="bg-secondary rounded me-3 d-flex align-items-center justify-content-center" 
                                         style="width: 40px; height: 40px;">
                                        <i class="fas fa-utensils text-light"></i>
                                    </div>
                                    {% endif %}
                                    <div>
                                        <div class="fw-medium text-white">{{ item.name }}</div>
                                        <small class="text-muted">{{ item.description[:50] }}...</small>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <span class="badge bg-railway-secondary">{{ item.restaurant.name }}</span>
                            </td>
                            <td>
                                <span class="badge bg-railway-primary">{{ item.category }}</span>
                            </td>
                            <td class="text-white">${{ "%.2f"|format(item.price) }}</td>
                            <td>
                                {% if item.is_available %}
                                <span class="badge bg-success">Available</span>
                                {% else %}
                                <span class="badge bg-danger">Unavailable</span>
                                {% endif %}
                            </td>
                            <td class="text-muted small">{{ item.created_at.strftime('%Y-%m-%d') }}</td>
                            <td class="text-end pe-4">
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-primary" 
                                            onclick="editMenuItem('{{ item.item_id }}')">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-outline-warning"
                                            onclick="toggleAvailability('{{ item.item_id }}', {{ item.is_available|lower }})">
                                        <i class="fas fa-{% if item.is_available %}ban{% else %}check{% endif %}"></i>
                                    </button>
                                    <button class="btn btn-outline-danger"
                                            onclick="deleteMenuItem('{{ item.item_id }}')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="7" class="text-center py-5">
                                <i class="fas fa-utensils fa-3x text-muted mb-3"></i>
                                <h5 class="text-muted">No menu items found</h5>
                                <p class="text-muted small">
                                    {% if request.args %}
                                        No items match your filters. Try adjusting your search criteria.
                                    {% else %}
                                        Add your first menu item to get started
                                    {% endif %}
                                </p>
                                <button class="btn btn-primary mt-2" data-bs-toggle="modal" 
                                        data-bs-target="#addMenuItemModal">
                                    <i class="fas fa-plus-circle me-2"></i>Add Menu Item
                                </button>
                                {% if request.args %}
                                <a href="{{ url_for('admin.manage_menu_items') }}" class="btn btn-outline-secondary mt-2 ms-2">
                                    <i class="fas fa-times me-2"></i>Clear Filters
                                </a>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Pagination -->
    {% if menu_items and menu_items|length > 0 %}
    <div class="d-flex justify-content-between align-items-center mt-4">
        <div class="text-muted small">
            Showing {{ ((current_page - 1) * per_page) + 1 }} to 
            {{ min(current_page * per_page, total_items) }} of {{ total_items }} items
        </div>
        {% if total_pages > 1 %}
        <nav>
            <ul class="pagination pagination-sm">
                <!-- Previous button -->
                <li class="page-item {% if not has_prev %}disabled{% endif %}">
                    <a class="page-link" 
                       href="{{ url_for('admin.manage_menu_items', page=current_page-1, **request.args) }}">
                        Previous
                    </a>
                </li>
                
                <!-- Page numbers -->
                {% for page_num in range(1, total_pages + 1) %}
                    {% if page_num == 1 or page_num == total_pages or (page_num >= current_page - 2 and page_num <= current_page + 2) %}
                        <li class="page-item {% if page_num == current_page %}active{% endif %}">
                            <a class="page-link" 
                               href="{{ url_for('admin.manage_menu_items', page=page_num, **request.args) }}">
                                {{ page_num }}
                            </a>
                        </li>
                    {% elif page_num == current_page - 3 or page_num == current_page + 3 %}
                        <li class="page-item disabled">
                            <span class="page-link">...</span>
                        </li>
                    {% endif %}
                {% endfor %}
                
                <!-- Next button -->
                <li class="page-item {% if not has_next %}disabled{% endif %}">
                    <a class="page-link" 
                       href="{{ url_for('admin.manage_menu_items', page=current_page+1, **request.args) }}">
                        Next
                    </a>
                </li>
            </ul>
        </nav>
        {% endif %}
    </div>
    {% endif %}
</div>

<!-- Add Menu Item Modal -->
<div class="modal fade" id="addMenuItemModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-railway-card border-railway">
            <div class="modal-header border-railway">
                <h5 class="modal-title text-white">Add Menu Item</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addMenuItemForm">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label text-muted small">Restaurant *</label>
                            <select class="form-select border-railway" name="restaurant_id" required>
                                <option value="">Select Restaurant</option>
                                {% for restaurant in restaurants %}
                                <option value="{{ restaurant.restaurant_id }}">{{ restaurant.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label text-muted small">Category *</label>
                            <select class="form-select border-railway" name="category" required>
                                <option value="">Select Category</option>
                                {% for cat in categories %}
                                <option value="{{ cat }}">{{ cat }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-8">
                            <label class="form-label text-muted small">Item Name *</label>
                            <input type="text" class="form-control border-railway" 
                                   name="name" placeholder="e.g., Pepperoni Pizza" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label text-muted small">Price *</label>
                            <input type="number" class="form-control border-railway" 
                                   name="price" min="0" step="0.01" placeholder="0.00" required>
                        </div>
                        <div class="col-12">
                            <label class="form-label text-muted small">Description</label>
                            <textarea class="form-control border-railway" name="description" 
                                      rows="3" placeholder="Describe the menu item..."></textarea>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label text-muted small">Image URL</label>
                            <input type="url" class="form-control border-railway" 
                                   name="image_url" placeholder="https://example.com/image.jpg">
                            <div id="imagePreview" class="mt-2"></div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label text-muted small">Availability</label>
                            <div class="form-check">
                                <input class="form-check-input border-railway" type="checkbox" 
                                       name="is_available" id="isAvailable" checked>
                                <label class="form-check-label text-muted small" for="isAvailable">
                                    Available for ordering
                                </label>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-railway">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveMenuItem()">
                    <i class="fas fa-save me-2"></i>Save Menu Item
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Menu Item Modal -->
<div class="modal fade" id="editMenuItemModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-railway-card border-railway">
            <div class="modal-header border-railway">
                <h5 class="modal-title text-white">Edit Menu Item</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Dynamic content will be loaded here -->
            </div>
        </div>
    </div>
</div>

<style>
.border-railway {
    border-color: var(--railway-border) !important;
}

.bg-railway-card {
    background: var(--railway-card) !important;
}

.bg-railway-primary {
    background: rgba(102, 126, 234, 0.15) !important;
    color: var(--railway-primary) !important;
    border: 1px solid rgba(102, 126, 234, 0.3);
}

.bg-railway-secondary {
    background: rgba(156, 163, 175, 0.15) !important;
    color: var(--railway-text-secondary) !important;
    border: 1px solid rgba(156, 163, 175, 0.3);
}

.table-dark {
    --bs-table-bg: transparent;
    --bs-table-striped-bg: rgba(255, 255, 255, 0.02);
    --bs-table-hover-bg: rgba(255, 255, 255, 0.05);
}

.badge a {
    text-decoration: none;
    opacity: 0.8;
}

.badge a:hover {
    opacity: 1;
}
</style>

<script>
function editMenuItem(itemId) {
    // Show loading
    const modalBody = document.querySelector('#editMenuItemModal .modal-body');
    modalBody.innerHTML = `
        <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="text-muted mt-2">Loading item details...</p>
        </div>
    `;
    
    const modal = new bootstrap.Modal(document.getElementById('editMenuItemModal'));
    modal.show();
    
    fetch(`/admin/menu-items/${itemId}/edit`)
        .then(response => response.text())
        .then(html => {
            modalBody.innerHTML = html;
        })
        .catch(error => {
            modalBody.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Failed to load item details. Please try again.
                </div>
            `;
            console.error('Error:', error);
        });
}

function toggleAvailability(itemId, isAvailable) {
    if (!confirm(`Are you sure you want to ${isAvailable ? 'disable' : 'enable'} this menu item?`)) return;
    
    // Show loading on the button
    const button = event.target.closest('button');
    const originalHTML = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    button.disabled = true;
    
    fetch(`/admin/menu-items/${itemId}/toggle-availability`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]')?.content || ''
        },
        body: JSON.stringify({ is_available: !isAvailable })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(data.message, 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            button.innerHTML = originalHTML;
            button.disabled = false;
            showToast(data.message || 'Failed to update availability', 'error');
        }
    })
    .catch(error => {
        button.innerHTML = originalHTML;
        button.disabled = false;
        showToast('An error occurred. Please try again.', 'error');
        console.error('Error:', error);
    });
}

function deleteMenuItem(itemId) {
    if (!confirm('Are you sure you want to delete this menu item? This action cannot be undone.')) return;
    
    fetch(`/admin/menu-items/${itemId}`, {
        method: 'DELETE',
        headers: {
            'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]')?.content || ''
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(data.message, 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast(data.message || 'Failed to delete item', 'error');
        }
    })
    .catch(error => {
        showToast('An error occurred. Please try again.', 'error');
        console.error('Error:', error);
    });
}

function saveMenuItem() {
    const form = document.getElementById('addMenuItemForm');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());
    
    // Validate
    if (!validateMenuItemForm(data)) return;
    
    // Show loading
    const saveButton = document.querySelector('#addMenuItemModal .btn-primary');
    const originalButtonText = saveButton.innerHTML;
    saveButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Saving...';
    saveButton.disabled = true;
    
    fetch('/admin/menu-items', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]')?.content || ''
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(data.message, 'success');
            bootstrap.Modal.getInstance(document.getElementById('addMenuItemModal')).hide();
            setTimeout(() => location.reload(), 1000);
        } else {
            saveButton.innerHTML = originalButtonText;
            saveButton.disabled = false;
            showToast(data.message || 'Failed to save menu item', 'error');
        }
    })
    .catch(error => {
        saveButton.innerHTML = originalButtonText;
        saveButton.disabled = false;
        showToast('An error occurred. Please try again.', 'error');
        console.error('Error:', error);
    });
}

function validateMenuItemForm(data) {
    if (!data.name || data.name.trim().length < 2) {
        showToast('Item name must be at least 2 characters', 'error');
        return false;
    }
    
    if (!data.price || parseFloat(data.price) <= 0) {
        showToast('Price must be greater than 0', 'error');
        return false;
    }
    
    if (!data.restaurant_id) {
        showToast('Please select a restaurant', 'error');
        return false;
    }
    
    if (!data.category) {
        showToast('Please select a category', 'error');
        return false;
    }
    
    return true;
}

// Image preview functionality
document.addEventListener('DOMContentLoaded', function() {
    const imageUrlInput = document.querySelector('input[name="image_url"]');
    if (imageUrlInput) {
        imageUrlInput.addEventListener('input', function() {
            const preview = document.getElementById('imagePreview');
            if (this.value) {
                preview.innerHTML = `
                    <small class="text-muted">Preview:</small><br>
                    <img src="${this.value}" class="img-thumbnail mt-1" 
                         style="max-width: 100px; max-height: 100px;" 
                         onerror="this.onerror=null; this.style.display='none';">
                `;
            } else {
                preview.innerHTML = '';
            }
        });
    }
    
    // Auto-submit filters on Enter key in search (if you add search later)
    document.querySelectorAll('#filterForm input').forEach(input => {
        input.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('filterForm').submit();
            }
        });
    });
});

// Show toast notification
function showToast(message, type = 'info') {
    // Check if toast container exists, create if not
    let toastContainer = document.getElementById('toastContainer');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.id = 'toastContainer';
        toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
        toastContainer.style.zIndex = '1060';
        document.body.appendChild(toastContainer);
    }
    
    const toastId = 'toast-' + Date.now();
    const toastHtml = `
        <div id="${toastId}" class="toast align-items-center border-0 bg-${type}" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body text-white">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'} me-2"></i>
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    `;
    
    toastContainer.insertAdjacentHTML('beforeend', toastHtml);
    const toastElement = document.getElementById(toastId);
    const toast = new bootstrap.Toast(toastElement, { delay: 3000 });
    toast.show();
    
    // Remove toast after it's hidden
    toastElement.addEventListener('hidden.bs.toast', function () {
        this.remove();
    });
}
</script>
{% endblock %}